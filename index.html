<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ğŸ§§ Quay LÃ¬ XÃ¬ Táº¿t</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.8.0/Winwheel.min.js"></script>

<style>
body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg,#a30000,#ffcc00);
    color: #fff;
}
h1 { text-align:center; color:#ffd700; }

.container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    padding: 10px;
}
.panel {
    background: rgba(0,0,0,.3);
    border-radius: 16px;
    padding: 15px;
    flex: 1;
    min-width: 280px;
}

textarea, input {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: none;
    margin-bottom: 10px;
}

button {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: none;
    font-weight: bold;
    background: #ffd700;
    color: #900;
}

#wheel-container {
    max-width: 360px;
    margin: auto;
    position: relative;
}
#pointer {
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 16px solid transparent;
    border-right: 16px solid transparent;
    border-bottom: 28px solid red;
    z-index: 10;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    color: #333;
    border-radius: 10px;
    font-size: 14px;
}
th, td {
    padding: 6px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}
th { background: #ffd700; }

.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
}
.modal-content {
    background: #fff;
    color: #333;
    padding: 20px;
    border-radius: 16px;
    width: 300px;
    text-align: center;
}

.mc-locked {
    pointer-events: none;
    opacity: 0.5;
}

.mc-hidden {
    display: none !important;
}

.mai {
    position: fixed;
    top: -50px;
    font-size: 20px;
    animation: fall linear infinite;
}
@keyframes fall {
    to { transform: translateY(110vh) rotate(360deg); }
}
</style>
</head>

<body>

<h1>ğŸŠ Quay LÃ¬ XÃ¬ Äáº§u NÄƒm ğŸŠ</h1>
<div style="text-align:center;margin-bottom:10px">
    <button id="btnLogin" onclick="document.getElementById('mcModal').style.display='flex'">
        ğŸ¤ MC Login
    </button>
    <button id="btnLogout" onclick="logoutMC()" style="display:none" class="btn danger">
        ÄÄƒng xuáº¥t MC
    </button>
</div>
<div class="modal" id="mcModal">
    <div class="modal-content">
        <h3>ğŸ¤ ÄÄƒng nháº­p MC</h3>
        <input type="password" id="mcPassword" placeholder="Nháº­p máº­t kháº©u MC" />
        <button onclick="loginMC()">ÄÄƒng nháº­p</button>
    </div>
</div>

<div class="container mc-config">
    <div class="panel">
        <h3>ğŸ‘¥ Danh sÃ¡ch ngÆ°á»i</h3>
        <textarea id="names" rows="6"></textarea>

        <h3>ğŸ’° Má»‡nh giÃ¡ : trá»ng sá»‘</h3>
        <textarea id="amounts" rows="4"></textarea>

        <button onclick="saveData()">ğŸ’¾ LÆ°u dá»¯ liá»‡u</button>
    </div>

    <div class="panel">
        <div id="wheel-container">
            <div id="pointer"></div>
            <canvas id="wheelCanvas" width="350" height="350"></canvas>
        </div>
        <button onclick="spinWheel()">ğŸ‰ QUAY</button>
    </div>
</div>


<div class="container">
    <div class="panel">
        <h3>ğŸ“œ Lá»‹ch sá»­ trÃºng lÃ¬ xÃ¬</h3>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>TÃªn</th>
                    <th>Má»‡nh giÃ¡</th>
                    <th>Thá»i gian</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>

        <h3 style="margin-top:10px">
            ğŸ’° Tá»•ng tiá»n Ä‘Ã£ phÃ¡t:
            <span id="totalMoney">0</span>
        </h3>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="resultText"></h3>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<audio id="drum" src="https://assets.mixkit.co/sfx/preview/mixkit-drum-roll-566.mp3"></audio>
<audio id="win" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3"></audio>

<script>
const namesInput = document.getElementById("names");
const amountsInput = document.getElementById("amounts");
const modal = document.getElementById("modal");
const drum = document.getElementById("drum");
const win = document.getElementById("win");
const DEFAULT_AMOUNTS = [
    { value: "10k", weight: 27 },
    { value: "20k", weight: 49 },
    { value: "50k", weight: 16 },
    { value: "100k", weight: 7 },
    { value: "200k", weight: 1 }
];


let wheel;
let names = [];
let weightedAmounts = [];
let history = [];

/* ---------- STORAGE ---------- */
function saveData() {
    if (!isMC) return alert("Chá»‰ MC má»›i Ä‘Æ°á»£c thao tÃ¡c");

    localStorage.setItem("names", namesInput.value);
    localStorage.setItem("amounts", amountsInput.value);
    loadData();
}

const MC_PASSWORD = "tet2026";
let isMC = false;

function hash(text) {
    return btoa(text);
}

function checkMC() {
    const saved = localStorage.getItem("mc_auth");
    isMC = saved === hash(MC_PASSWORD);
    applyMCRole();
}

function applyMCRole() {
    const config = document.querySelector(".mc-config");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");

    if (isMC) {
        config.classList.remove("mc-hidden");
        btnLogin.style.display = "none";
        btnLogout.style.display = "inline-block";
    } else {
        config.classList.add("mc-hidden");
        btnLogin.style.display = "inline-block";
        btnLogout.style.display = "none";
    }
}



function loginMC() {
    const input = document.getElementById("mcPassword").value;
    if (hash(input) === hash(MC_PASSWORD)) {
        localStorage.setItem("mc_auth", hash(MC_PASSWORD));
        isMC = true;
        applyMCRole();
        document.getElementById("mcModal").style.display = "none";
        alert("ÄÄƒng nháº­p MC thÃ nh cÃ´ng!");
    } else {
        alert("Sai máº­t kháº©u!");
    }
}

function logoutMC() {
    localStorage.removeItem("mc_auth");

    localStorage.removeItem("history");

    history = [];

    renderHistory();

    location.reload();
}


function loadData() {
    namesInput.value = localStorage.getItem("names") || "";
    amountsInput.value = localStorage.getItem("amounts") || "";
    history = JSON.parse(localStorage.getItem("history") || "[]");

    names = namesInput.value.split("\n").map(n=>n.trim()).filter(Boolean);
    buildWeightedAmounts();
    buildWheel();
    renderHistory();
}

function useDefaultAmounts() {
    weightedAmounts = [];
    DEFAULT_AMOUNTS.forEach(item => {
        for (let i = 0; i < item.weight; i++) {
            weightedAmounts.push(item.value);
        }
    });

    // Optional: hiá»ƒn thá»‹ default lÃªn UI cho MC tháº¥y
    amountsInput.value = DEFAULT_AMOUNTS
        .map(i => `${i.value}:${i.weight}`)
        .join("\n");
}


/* ---------- WEIGHT ---------- */
function buildWeightedAmounts() {
    weightedAmounts = [];

    const lines = amountsInput.value
        .split("\n")
        .map(l => l.trim())
        .filter(Boolean);

    // Náº¿u khÃ´ng nháº­p gÃ¬ â†’ dÃ¹ng default
    if (lines.length === 0) {
        useDefaultAmounts();
        return;
    }

    lines.forEach(line => {
        if (!line.includes(":")) return;

        let [val, w] = line.split(":");
        val = val.trim();
        w = parseInt(w);

        if (!val || isNaN(w) || w <= 0) return;

        for (let i = 0; i < w; i++) {
            weightedAmounts.push(val);
        }
    });

    // Náº¿u táº¥t cáº£ dÃ²ng Ä‘á»u sai â†’ fallback default
    if (weightedAmounts.length === 0) {
        useDefaultAmounts();
    }
}


/* ---------- WHEEL ---------- */
function buildWheel() {
    if (!names.length) return;
    if (wheel) wheel.stopAnimation(false);

    wheel = new Winwheel({
        canvasId: 'wheelCanvas',
        numSegments: names.length,
        segments: names.map((n,i)=>({
            fillStyle: i%2?'#ffeb3b':'#ff5252',
            text: n
        })),
        animation: {
            type: 'spinToStop',
            spins: 8,
            duration: 5,
            callbackFinished: onFinished
        }
    });
}

function spinWheel() {
    if (!isMC) return alert("Chá»‰ MC má»›i Ä‘Æ°á»£c quay");

    if (!names.length || !weightedAmounts.length) {
        alert("Thiáº¿u dá»¯ liá»‡u");
        return;
    }
    
    drum.currentTime = 0;
    drum.play();
    wheel.startAnimation();
}

/* ---------- FINISH ---------- */
function onFinished(seg) {
    win.currentTime = 0;
    win.play();

    const winner = seg.text;
    const amount = weightedAmounts[Math.floor(Math.random()*weightedAmounts.length)];

    history.push({
        name: winner,
        amount: amount,
        time: new Date().toLocaleString("vi-VN")
    });
    localStorage.setItem("history", JSON.stringify(history));

    names = names.filter(n => n !== winner);
    namesInput.value = names.join("\n");
    localStorage.setItem("names", namesInput.value);

    document.getElementById("resultText").innerText =
        `ğŸ‰ ${winner} nháº­n ${amount}!`;

    firework();
    modal.style.display = "flex";

    buildWheel();
    renderHistory();
}

/* ---------- HISTORY ---------- */
function renderHistory() {
    const tbody = document.getElementById("historyBody");
    tbody.innerHTML = "";
    let total = 0;

    history.forEach((h,i)=>{
        const money = parseInt(h.amount);
        if (!isNaN(money)) total += money;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${h.name}</td>
            <td>${h.amount}</td>
            <td>${h.time}</td>`;
        tbody.appendChild(tr);
    });

    document.getElementById("totalMoney").innerText = total.toLocaleString() + "k";
}

function closeModal() {
    modal.style.display = "none";
}

/* ---------- EFFECT ---------- */
function firework() {
    for (let i=0;i<20;i++) {
        const f = document.createElement("div");
        f.className = "mai";
        f.innerText = "ğŸŒ¸";
        f.style.left = Math.random()*100 + "vw";
        f.style.animationDuration = 3 + Math.random()*3 + "s";
        document.body.appendChild(f);
        setTimeout(()=>f.remove(),6000);
    }
}

/* ---------- INIT ---------- */
checkMC();
loadData();
</script>

</body>
</html>
