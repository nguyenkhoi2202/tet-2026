<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ğŸ§§ Quay LÃ¬ XÃ¬ Táº¿t</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@2.8.0/Winwheel.min.js"></script>

<style>
body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg,#a30000,#ffcc00);
    color: #fff;
}
h1 { text-align:center; color:#ffd700; }

.container { display:flex; flex-wrap:wrap; gap:15px; padding:10px; }
.panel { background:rgba(0,0,0,.3); border-radius:16px; padding:15px; flex:1; min-width:280px; }

textarea,input {
    width:100%; padding:10px; border-radius:10px; border:none; margin-bottom:10px;
}

button {
    width:100%; padding:12px; border-radius:12px; border:none;
    font-weight:bold; background:#ffd700; color:#900;
}

#wheel-container { max-width:360px; margin:auto; position:relative; }
#pointer {
    position:absolute; top:-6px; left:50%; transform:translateX(-50%);
    width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;
    border-bottom:28px solid red; z-index:10;
}

.amount-btn {
    padding:8px 14px; border-radius:20px; border:none;
    font-weight:bold; background:#fff; color:#900; cursor:pointer;
}
.amount-btn.active { background:#00ffcc; color:#000; }

table { width:100%; border-collapse:collapse; background:#fff; color:#333; border-radius:10px; font-size:14px; }
th,td { padding:6px; border-bottom:1px solid #ddd; text-align:center; }
th { background:#ffd700; }

.modal {
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    display:none; align-items:center; justify-content:center;
}
.modal-content {
    background:#fff; color:#333; padding:20px;
    border-radius:16px; width:300px; text-align:center;
}

.mc-hidden { display:none!important; }
</style>
</head>

<body>

<h1>ğŸŠ Quay LÃ¬ XÃ¬ Äáº§u NÄƒm ğŸŠ</h1>

<div style="text-align:center;margin-bottom:10px">
    <button id="btnLogin" onclick="document.getElementById('mcModal').style.display='flex'">ğŸ¤ MC Login</button>
    <button id="btnLogout" onclick="logoutMC()" style="display:none">ÄÄƒng xuáº¥t MC</button>
</div>

<div class="modal" id="mcModal">
    <div class="modal-content">
        <h3>ğŸ¤ ÄÄƒng nháº­p MC</h3>
        <input type="password" id="mcPassword" placeholder="Nháº­p máº­t kháº©u MC" />
        <button onclick="loginMC()">ÄÄƒng nháº­p</button>
    </div>
</div>

<div class="container mc-config">
    <div class="panel">
        <h3>ğŸ‘¥ Danh sÃ¡ch ngÆ°á»i</h3>
        <textarea id="names" rows="6"></textarea>

        <div id="amountConfig">
            <h3>ğŸ’° Má»‡nh giÃ¡ : trá»ng sá»‘</h3>
            <textarea id="amounts" rows="4"></textarea>
        </div>

        <button onclick="saveData()">ğŸ’¾ LÆ°u dá»¯ liá»‡u</button>
        <button onclick="document.getElementById('amountConfig').style.display='block'">âš™ï¸ Hiá»‡n cáº¥u hÃ¬nh tiá»n</button>
    </div>

    <div class="panel">

        <!-- MODE SELECT -->
        <h3>ğŸ¯ Cháº¿ Ä‘á»™ má»‡nh giÃ¡</h3>
        <select id="amountMode" onchange="changeAmountMode()" style="width:100%;padding:10px;border-radius:10px;margin-bottom:10px">
            <option value="manual">ğŸ¯ Chá»n má»‡nh giÃ¡ thá»§ cÃ´ng</option>
            <option value="random">ğŸ² Random má»‡nh giÃ¡</option>
        </select>

        <h3>ğŸ Chá»n má»‡nh giÃ¡ quay</h3>
        <div id="amountButtons" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px"></div>

        <div id="wheel-container">
            <div id="pointer"></div>
            <canvas id="wheelCanvas" width="350" height="350"></canvas>
        </div>

        <button onclick="spinWheel()">ğŸ‰ QUAY</button>
    </div>
</div>

<div class="container">
    <div class="panel">
        <h3>ğŸ“œ Lá»‹ch sá»­ trÃºng lÃ¬ xÃ¬</h3>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>TÃªn</th>
                    <th>Má»‡nh giÃ¡</th>
                    <th>Thá»i gian</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
        <h3 style="margin-top:10px">ğŸ’° Tá»•ng tiá»n Ä‘Ã£ phÃ¡t: <span id="totalMoney">0</span></h3>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="resultText"></h3>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<script>
const namesInput = document.getElementById("names");
const amountsInput = document.getElementById("amounts");
const modal = document.getElementById("modal");

const DEFAULT_AMOUNTS = [
    { value:"10k", weight:50 },
    { value:"50k", weight:30 },
    { value:"100k", weight:15 },
    { value:"200k", weight:5 }
];

let wheel, names=[], weightedAmounts=[], history=[], currentAmount=null;

/* ===== MC LOGIN ===== */
const MC_PASSWORD="tet2026";
let isMC=false;
function hash(t){return btoa(t);}
function checkMC(){
    isMC = localStorage.getItem("mc_auth")===hash(MC_PASSWORD);
    applyMCRole();
}
function applyMCRole(){
    const config=document.querySelector(".mc-config");
    const btnLogin=document.getElementById("btnLogin");
    const btnLogout=document.getElementById("btnLogout");
    if(isMC){
        config.classList.remove("mc-hidden");
        btnLogin.style.display="none";
        btnLogout.style.display="inline-block";
    } else {
        config.classList.add("mc-hidden");
        btnLogin.style.display="inline-block";
        btnLogout.style.display="none";
    }
}
function loginMC(){
    if(hash(document.getElementById("mcPassword").value)===hash(MC_PASSWORD)){
        localStorage.setItem("mc_auth",hash(MC_PASSWORD));
        isMC=true; applyMCRole();
        document.getElementById("mcModal").style.display="none";
    } else alert("Sai máº­t kháº©u");
}
function logoutMC(){ localStorage.clear(); location.reload(); }

/* ===== SAVE & LOAD ===== */
function saveData(){
    if(!isMC) return alert("Chá»‰ MC thao tÃ¡c");
    localStorage.setItem("names",namesInput.value);
    localStorage.setItem("amounts",amountsInput.value);
    loadData();
    document.getElementById("amountConfig").style.display="none";
}

function loadData(){
    namesInput.value = localStorage.getItem("names")||"";
    amountsInput.value = localStorage.getItem("amounts")||"";
    history = JSON.parse(localStorage.getItem("history")||"[]");

    names = namesInput.value.split("\n").map(n=>n.trim()).filter(Boolean);
    buildWeightedAmounts();
    buildWheel();
    renderAmountButtons();
    renderHistory();

    if(localStorage.getItem("amounts")) document.getElementById("amountConfig").style.display="none";
    changeAmountMode();
}

/* ===== WEIGHT BUILD ===== */
function buildWeightedAmounts(){
    weightedAmounts=[];
    const lines = amountsInput.value.split("\n").map(l=>l.trim()).filter(Boolean);
    if(lines.length===0){
        DEFAULT_AMOUNTS.forEach(i=>{
            for(let j=0;j<i.weight;j++) weightedAmounts.push(i.value);
        });
        return;
    }
    lines.forEach(l=>{
        if(!l.includes(":")) return;
        let [v,w]=l.split(":");
        v=v.trim(); w=parseInt(w);
        if(!v||!w) return;
        for(let i=0;i<w;i++) weightedAmounts.push(v);
    });
}

/* ===== AMOUNT BUTTONS ===== */
function renderAmountButtons(){
    const box=document.getElementById("amountButtons");
    box.innerHTML="";
    [...new Set(weightedAmounts)].forEach(v=>{
        const b=document.createElement("button");
        b.className="amount-btn";
        b.innerText=v;
        b.onclick=()=>{
            document.querySelectorAll(".amount-btn").forEach(x=>x.classList.remove("active"));
            b.classList.add("active");
            currentAmount=v;
        };
        box.appendChild(b);
    });
}

/* ===== MODE ===== */
function changeAmountMode(){
    const mode=document.getElementById("amountMode").value;
    const box=document.getElementById("amountButtons");
    box.style.display = (mode==="random") ? "none" : "flex";
}

/* ===== WHEEL ===== */
function buildWheel(){
    if(!names.length) return;
    wheel = new Winwheel({
        canvasId:'wheelCanvas',
        numSegments:names.length,
        segments:names.map((n,i)=>({ fillStyle:i%2?'#ffeb3b':'#ff5252', text:n })),
        animation:{ type:'spinToStop', spins:8, duration:5, callbackFinished:onFinished }
    });
}

function pickWeightedAmount(){
    return weightedAmounts[Math.floor(Math.random()*weightedAmounts.length)];
}

function spinWheel(){
    if(!isMC) return alert("Chá»‰ MC Ä‘Æ°á»£c quay");
    const mode=document.getElementById("amountMode").value;

    if(mode==="manual"){
        if(!currentAmount) return alert("ChÆ°a chá»n má»‡nh giÃ¡");
    } else {
        currentAmount = pickWeightedAmount();
        console.log("Random amount:", currentAmount); // MC xem trong console
    }

    wheel.startAnimation();
}

/* ===== FINISH ===== */
function onFinished(seg){
    const winner = seg.text;
    const amount = currentAmount;

    history.push({name:winner,amount,time:new Date().toLocaleString("vi-VN")});
    localStorage.setItem("history",JSON.stringify(history));

    names = names.filter(n=>n!==winner);
    namesInput.value = names.join("\n");
    localStorage.setItem("names",namesInput.value);

    document.getElementById("resultText").innerText = `ğŸ‰ ${winner} nháº­n ${amount}!`;
    modal.style.display="flex";

    currentAmount=null;
    document.querySelectorAll(".amount-btn").forEach(b=>b.classList.remove("active"));
    buildWheel();
    renderHistory();
}

/* ===== HISTORY ===== */
function renderHistory(){
    const tbody=document.getElementById("historyBody");
    tbody.innerHTML="";
    let total=0;
    history.forEach((h,i)=>{
        const m=parseInt(h.amount);
        if(!isNaN(m)) total+=m;
        tbody.innerHTML+=`<tr><td>${i+1}</td><td>${h.name}</td><td>${h.amount}</td><td>${h.time}</td></tr>`;
    });
    document.getElementById("totalMoney").innerText = total + "k";
}

function closeModal(){ modal.style.display="none"; }

/* INIT */
checkMC();
loadData();
</script>

</body>
</html>